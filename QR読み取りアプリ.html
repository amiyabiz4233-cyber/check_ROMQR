async function captureAndOCR() {
    const video = document.querySelector('#reader video');
    if(!video) return;
    html5QrCode.pause();
    
    document.getElementById('confirm-overlay').style.display = 'flex';
    document.getElementById('ai-loading-text').style.display = 'block';
    document.getElementById('ai-result-area').style.display = 'none';

    try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const base64Image = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

        // タイムアウト付きで通信
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                contents: [{ parts: [{ text: "数字のみ抽出" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] 
            }),
            signal: controller.signal
        });
        
        const data = await response.json();
        clearTimeout(timeoutId);

        if (data.error) {
            // エラーの詳細を表示（これが解決の鍵です！）
            alert(`Googleからのエラー:\n理由: ${data.error.status}\nメッセージ: ${data.error.message}`);
            throw new Error(data.error.message);
        }

        const aiResult = data.candidates[0].content.parts[0].text.trim().replace(/\D/g, "");
        showConfirmation(aiResult || "読取不可");
    } catch (e) {
        if (e.name === 'AbortError') alert("通信タイムアウト。ネット環境を確認してください。");
        rejectValue();
    }
}
